<ruby>
home_dir = Dir.home
directory_name = "#{home_dir}/msf_#{framework.db.workspace.name}_output"
Dir.mkdir(directory_name) unless File.exist?(directory_name)

msf_base = "/opt/metasploit-framework/embedded/framework"
if File.file?("#{msf_base}/msfconsole")
  self.run_single("spool #{directory_name}/msf-exploits-console-output.log")
  grep_cmd = `grep -rl 'Exploit::CheckCode' #{msf_base}/modules/exploits/|grep -vE '/local/|/android/'|sort -t'/' -k8`.split
  grep_cmd.sort.each do |file_name|
    file_name.slice! "#{msf_base}/modules/exploits/"
    file_name.slice! ".rb"
    print_status("Using exploit/#{file_name}")
    self.run_single("use exploit/#{file_name}")
    self.run_single("resource stubs/stub_all_tcp_explt_rhost.rb")
    self.run_single("back")
  end
  self.run_single("spool off")
  self.run_single("back")
  grep_cmd = `egrep '\[\+\]|Using ' #{directory_name}/msf-exploits-console-output.log |grep -B10 '\[+\]'`
  print_status "Showing filtered output from #{directory_name}/msf-exploits-console-output.log"
  print_status "#{grep_cmd}"
else
  print_error('!')
  print_error("! A MetaSploit directory was not found in #{msf_base}")
  print_error('!')
end
</ruby>
